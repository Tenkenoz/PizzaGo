<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido - Sistema de Inventario</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="./CSS/estiloprincipal.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Barra lateral -->
            <div class="col-md-3 col-lg-2 sidebar bg-dark text-white p-3">
                <h4 class="text-center mb-4">Inventario</h4>
                <a href="#dashboard" class="nav-link active text-white"> 
                    <i class="fas fa-chart-line"></i> Panel de control 
                </a>
                <a href="./Usuario.html" class="nav-link text-white"> 
                    <i class="fas fa-user"></i> Usuarios 
                </a>
                <a href="./producto.html" class="nav-link text-white"> 
                    <i class="fas fa-box"></i> Productos 
                </a>
                <a href="./venta.html" class="nav-link text-white"> 
                    <i class="fas fa-shopping-cart"></i> Ventas 
                </a>
                <a href="./pedidos.html" class="nav-link text-white"> 
                    <i class="fas fa-list"></i> Pedidos
                </a>
            </div>

            <!-- Contenido principal -->
            <div class="col-md-9 col-lg-10 content p-4">
                <!-- Panel de tarjetas -->
                <div id="dashboard" class="container-fluid">
                    <div class="row mb-4">
                        <!-- Tarjetas del panel -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">Usuarios</h5>
                                        <h3 id="usuarios-count">0</h3>
                                    </div>
                                    <i class="fa fa-user card-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">Pedidos</h5>
                                        <h3 id="pedidos-count">0</h3>
                                    </div>
                                    <i class="fa fa-list card-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">Productos</h5>
                                        <h3 id="productos-count">0</h3>
                                    </div>
                                    <i class="fa fa-box card-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">Ventas</h5>
                                        <h3 id="ventas-count">0</h3>
                                    </div>
                                    <i class="fa fa-shopping-cart card-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gestión de pedidos -->
                <div id="pedidos" class="container">
                    <div class="header text-center mb-4">
                        <h2>Gestión de Pedidos</h2>
                    </div>
                    <div class="row justify-content-center">
                        <!-- Tarjetas de acciones -->
                        <div class="col-md-4 mb-3">
                            <div class="card action-card text-center" id="add-pedido">
                                <div class="card-body">
                                    <i class="fas fa-plus-circle fa-3x mb-3"></i>
                                    <h5 class="card-title">Agregar Pedido</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card action-card text-center" id="edit-pedido">
                                <div class="card-body">
                                    <i class="fas fa-edit fa-3x mb-3"></i>
                                    <h5 class="card-title">Modificar Pedido</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card action-card text-center" id="delete-pedido">
                                <div class="card-body">
                                    <i class="fas fa-minus-circle fa-3x mb-3"></i>
                                    <h5 class="card-title">Eliminar Pedido</h5>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario para agregar, modificar o eliminar pedidos -->
                    <div id="form-container" class="mt-4" style="display: none;">
                        <h2 id="form-title" class="text-center mb-4"></h2>
                        <form id="pedido-form">
                            <div class="mb-3" id="pedido-id-container">
                                <label for="pedidoId" class="form-label">ID del Pedido</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pedidoId" placeholder="ID del Pedido" >
                                    <button type="button" class="btn btn-primary" id="buscar-pedido-btn">Buscar Pedido</button>
                                </div>
                            </div>
                            <div class="mb-3" id="cliente-container">
                                <label for="cliente" class="form-label">Cliente</label>
                                <input type="text" id="cliente" class="form-control" placeholder="Cliente del pedido" >
                            </div>
                            <div class="mb-3" id="producto-container">
                                <label for="producto" class="form-label">Producto</label>
                                <input type="text" id="producto" class="form-control" placeholder="Nombre del producto" >
                            </div>
                            <div class="mb-3" id="cantidad-container">
                                <label for="cantidad" class="form-label">Cantidad</label>
                                <input type="number" id="cantidad" class="form-control" placeholder="Cantidad de productos" >
                            </div>
                            <div class="mb-3" id="total-container">
                                <label for="total" class="form-label">Total</label>
                                <input type="text" id="total" class="form-control" placeholder="Total del pedido" >
                            </div>
                            <div class="mb-3" id="metodo-pago-container">
                                <label for="metodo_pago" class="form-label">Método de Pago</label>
                                <input type="text" id="metodo_pago" class="form-control" value="Efectivo">
                                
                            </div>
                            <div class="mb-3" id="estado-container">
                                <label for="estado" class="form-label">Estado</label>
                                <select id="estado" class="form-control">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Completado">Completado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="mb-3" id="direccion-container">
                                <label for="direccion_entrega" class="form-label">Dirección de Entrega</label>
                                <input type="text" id="direccion_entrega" class="form-control" placeholder="Dirección de entrega">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Completar</button>
                        </form>
                    </div>
                </div>
                <div id="lista-pedidos" class="container mt-5">
                    <div class="header text-center mb-4">
                        <h2>Lista de Pedidos</h2>
                    </div>
                    <button id="actualizar-pedidos" class="btn btn-primary mb-3">Actualizar Lista</button>
                    <input type="text" id="buscar-pedido" class="form-control mb-3" placeholder="Buscar pedido por ID o nombre...">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>ID Pedido</th>
                                <th>ID Usuario</th>
                                <th>Productos</th>
                                <th>Total</th>
                                <th>Método de Pago</th>
                                <th>Estado</th>
                                <th>Dirección Entrega</th>
                                <th>Fecha Pedido</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-pedidos">
                            <!-- Aquí se insertarán los pedidos dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Búsqueda en la tabla de pedidos
        document.getElementById('buscar-pedido').addEventListener('keyup', function () {
            const textoBusqueda = this.value.toLowerCase();
            const filas = document.querySelectorAll('#tabla-pedidos tr');

            filas.forEach(fila => {
                const celdas = fila.querySelectorAll('td');
                let mostrarFila = false;

                // Buscar en todas las celdas de la fila
                celdas.forEach(celda => {
                    if (celda.textContent.toLowerCase().includes(textoBusqueda)) {
                        mostrarFila = true;
                    }
                });

                // Mostrar u ocultar la fila según el resultado de la búsqueda
                fila.style.display = mostrarFila ? '' : 'none';
            });
        });

        // Actualizar la tabla de pedidos
        document.getElementById('actualizar-pedidos').addEventListener('click', function () {
            fetch('http://localhost:5000/get-pedidos')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener los pedidos');
                    }
                    return response.json();
                })
                .then(data => {
                    const tabla = document.getElementById('tabla-pedidos');
                    tabla.innerHTML = ''; // Limpiar la tabla antes de actualizar

                    // Construir las filas de la tabla
                    data.forEach(pedido => {
                        const productos = pedido.productos.map(producto => `${producto.nombre} (x${producto.cantidad})`).join(', ');
                        const fila = `<tr>
                            <td>${pedido._id}</td>
                            <td>${pedido.usuario_id}</td>
                            <td>${productos}</td>
                            <td>${pedido.total}</td>
                            <td>${pedido.metodo_pago}</td>
                            <td>${pedido.estado}</td>
                            <td>${pedido.direccion_entrega}</td>
                            <td>${new Date(pedido.fecha_pedido).toLocaleString()}</td>
                        </tr>`;
                        tabla.innerHTML += fila;
                    });
                })
                .catch(error => {
                    console.error('Error al obtener pedidos:', error);
                    alert('Hubo un error al obtener los pedidos. Por favor, inténtalo de nuevo.');
                });
        });

        // Mostrar el formulario según la acción seleccionada
        document.querySelectorAll('.action-card').forEach(card => {
            card.addEventListener('click', function () {
                const action = this.id; // Acción seleccionada: 'add-pedido', 'edit-pedido', 'delete-pedido'
                const formTitleMap = {
                    'add-pedido': 'Agregar Pedido',
                    'edit-pedido': 'Modificar Pedido',
                    'delete-pedido': 'Eliminar Pedido'
                };

                // Mostrar u ocultar campos según la acción
                document.getElementById('pedido-id-container').style.display = action === 'add-pedido' ? 'none' : 'block';
                document.getElementById('cliente-container').style.display = action === 'delete-pedido' ? 'none' : 'block';
                document.getElementById('producto-container').style.display = action === 'delete-pedido' ? 'none' : 'block';
                document.getElementById('cantidad-container').style.display = action === 'delete-pedido' ? 'none' : 'block';
                document.getElementById('total-container').style.display = action === 'delete-pedido' ? 'none' : 'block';
                document.getElementById('metodo-pago-container').style.display = action === 'delete-pedido' ? 'none' : 'block';
                document.getElementById('estado-container').style.display = action === 'delete-pedido' ? 'none' : 'block';
                document.getElementById('direccion-container').style.display = action === 'delete-pedido' ? 'none' : 'block';

                // Mostrar el formulario y establecer el título
                document.getElementById('form-container').style.display = 'block';
                document.getElementById('form-title').textContent = formTitleMap[action];
                document.getElementById('pedido-form').setAttribute('data-action', action);
            });
        });

        // Buscar pedido por ID y llenar el formulario
        document.getElementById('buscar-pedido-btn').addEventListener('click', function () {
            const pedidoId = document.getElementById('pedidoId').value;
            if (!pedidoId) {
                alert('Por favor, ingrese un ID de pedido válido.');
                return;
            }

            fetch(`http://localhost:5000/get-pedido/${pedidoId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Pedido no encontrado');
        }
        return response.json();
    })
    .then(pedido => {
        // Llenar los campos del formulario con los datos del pedido
        document.getElementById('cliente').value = pedido.usuario_id;
        document.getElementById('total').value = pedido.total;
        document.getElementById('metodo_pago').value= pedido.metodo_pago;
        document.getElementById('estado').value = pedido.estado;
        document.getElementById('direccion_entrega').value = pedido.direccion_entrega;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('No se pudo encontrar el pedido. Verifique el ID e intente nuevamente.');
    });
        });

        // Enviar el formulario
        document.getElementById('pedido-form').addEventListener('submit', function (event) {
            event.preventDefault(); // Evitar el comportamiento por defecto del formulario

            const action = this.getAttribute('data-action'); // Obtener la acción del formulario
            const pedidoId = document.getElementById('pedidoId').value;
            const cliente = document.getElementById('cliente').value;
            const producto = document.getElementById('producto').value;
            const cantidad = document.getElementById('cantidad').value;
            const total = document.getElementById('total').value;
            const metodoPago = document.getElementById('metodo_pago').value;
            const estado = document.getElementById('estado').value;
            const direccionEntrega = document.getElementById('direccion_entrega').value;

           

            // Configurar la URL y el método según la acción
            let url, method, data;
            if (action === 'add-pedido') {
                url = 'http://127.0.0.1:5000/realizar-pedido';
                method = 'POST';
                data = {
                    usuario_id: cliente,
                    productos: [{ nombre: producto, cantidad: parseInt(cantidad) }],
                    total: parseFloat(total),
                    metodo_pago: metodoPago,
                    estado: estado,
                    direccion_entrega: direccionEntrega,
                    fecha_pedido: new Date().toISOString() // Fecha actual en formato ISO
                };
            } else if (action === 'edit-pedido') {
                url = `http://127.0.0.1:5000/modificar-pedido/${pedidoId}`;
                method = 'PUT';
                data = {
                    usuario_id: cliente,
                    total: parseFloat(total),
                    metodo_pago: metodoPago,
                    estado: estado,
                    direccion_entrega: direccionEntrega
                };
            } else if (action === 'delete-pedido') {
                url = `http://127.0.0.1:5000/eliminar-pedido/${pedidoId}`;
                method = 'DELETE';
                data = null; // No se necesita enviar datos en una solicitud DELETE
            }

            // Enviar la solicitud al servidor
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: method !== 'DELETE' ? JSON.stringify(data) : null
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la solicitud');
                    }
                    return response.json();
                })
                .then(responseData => {
                    alert(responseData.message); // Mostrar mensaje de éxito
                    document.getElementById('form-container').style.display = 'none'; // Ocultar el formulario
                    document.getElementById('actualizar-pedidos').click(); // Actualizar la tabla de pedidos
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Hubo un error al procesar la solicitud. Por favor, inténtalo de nuevo.');
                });
        });
    </script>

    <script src="./JS/panel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>